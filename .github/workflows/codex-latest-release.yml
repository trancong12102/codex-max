name: Build Codex CLI (latest upstream)

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest
    concurrency:
      group: codex-release-latest
      cancel-in-progress: true
    env:
      UPSTREAM_REPO: openai/codex
      RELEASE_PREFIX: codex-
      BUILD_TARGET: aarch64-apple-darwin
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Resolve latest upstream release tag
        id: upstream
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          releases="$(gh api --paginate -H "Accept: application/vnd.github+json" "/repos/${UPSTREAM_REPO}/releases?per_page=100")"
          latest_json="$(echo "$releases" | jq -r '[.[] | select(.tag_name != null and (.draft == false))] | sort_by(.published_at // .created_at // .tag_name) | last')"
          if [ -z "$latest_json" ] || [ "$latest_json" = "null" ]; then
            echo "No releases found for $UPSTREAM_REPO" >&2
            exit 1
          fi
          tag="$(echo "$latest_json" | jq -r '.tag_name')"
          prerelease="$(echo "$latest_json" | jq -r '.prerelease // false')"
          if [ -z "$tag" ] || [ "$tag" = "null" ]; then
            echo "Latest release tag missing for $UPSTREAM_REPO" >&2
            exit 1
          fi
          echo "tag=$tag" >> "$GITHUB_OUTPUT"
          echo "prerelease=$prerelease" >> "$GITHUB_OUTPUT"

      - name: Check if release already exists
        id: existing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          release_tag="${RELEASE_PREFIX}${{ steps.upstream.outputs.tag }}"
          if gh release view "$release_tag" >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi
          echo "release_tag=$release_tag" >> "$GITHUB_OUTPUT"

      - name: Stop early if release exists
        if: steps.existing.outputs.exists == 'true'
        run: echo "Release ${{ steps.existing.outputs.release_tag }} already exists; skipping."

      - name: Clone upstream at tag
        if: steps.existing.outputs.exists == 'false'
        run: |
          set -euo pipefail
          git clone --depth 1 --branch "${{ steps.upstream.outputs.tag }}" "https://github.com/${UPSTREAM_REPO}.git" codex-src

      - name: Patch model/effort defaults and max sub-agent threads
        if: steps.existing.outputs.exists == 'false'
        run: |
          set -euo pipefail
          presets_file="$(find codex-src -path "*/codex-rs/core/src/models_manager/collaboration_mode_presets.rs" -print -quit)"
          if [ -z "$presets_file" ]; then
            echo "collaboration_mode_presets.rs not found" >&2
            exit 1
          fi
          explorer_config_file="$(find codex-src -path "*/codex-rs/core/src/agent/builtins/explorer.toml" -print -quit)"
          if [ -z "$explorer_config_file" ]; then
            echo "agent/builtins/explorer.toml not found" >&2
            exit 1
          fi
          config_file="$(find codex-src -path "*/codex-rs/core/src/config/mod.rs" -print -quit)"
          if [ -z "$config_file" ]; then
            echo "config/mod.rs not found" >&2
            exit 1
          fi
          export PRESETS_FILE_PATH="$presets_file"
          export EXPLORER_CONFIG_FILE_PATH="$explorer_config_file"
          export CONFIG_FILE_PATH="$config_file"
          python - <<'PY'
          from pathlib import Path
          import os
          import re

          target_model = "gpt-5.3-codex"

          presets_path = Path(os.environ["PRESETS_FILE_PATH"])
          presets_text = presets_path.read_text()
          presets_updated = presets_text

          presets_updated, model_replacements = re.subn(
              r'(?m)^(\s*)model:\s*(?:None|Some\(".*?"\.to_string\(\)\)),\s*$',
              rf'\1model: Some("{target_model}".to_string()),',
              presets_updated,
          )
          if model_replacements == 0:
              raise SystemExit(f"Expected model preset target not found in {presets_path}; refusing to continue.")

          presets_updated, reasoning_replacements = re.subn(
              r'(?m)^(\s*)reasoning_effort:\s*(?:None|Some\(Some\(ReasoningEffort::[A-Za-z0-9_]+\)\)),\s*$',
              r'\1reasoning_effort: Some(Some(ReasoningEffort::XHigh)),',
              presets_updated,
          )
          if reasoning_replacements == 0:
              raise SystemExit(f"Expected reasoning_effort preset target not found in {presets_path}; refusing to continue.")

          # Optional forward-compat: if upstream introduces thinking_effort in this file,
          # force it to XHigh as well.
          presets_updated, thinking_replacements = re.subn(
              r'(?m)^(\s*)thinking_effort:\s*Some\(Some\(([A-Za-z0-9_]+)::[A-Za-z0-9_]+\)\),\s*$',
              r'\1thinking_effort: Some(Some(\2::XHigh)),',
              presets_updated,
          )
          if presets_updated != presets_text:
              presets_path.write_text(presets_updated)
          print(
              f"Patched {presets_path} "
              f"(model: {model_replacements}, reasoning_effort: {reasoning_replacements}, "
              f"thinking_effort: {thinking_replacements})"
          )

          explorer_path = Path(os.environ["EXPLORER_CONFIG_FILE_PATH"])
          explorer_text = explorer_path.read_text()
          explorer_updated = explorer_text

          explorer_updated, explorer_model_replacements = re.subn(
              r'(?m)^model\s*=\s*".*"$',
              f'model = "{target_model}"',
              explorer_updated,
          )
          if explorer_model_replacements == 0:
              raise SystemExit(f"Expected model target not found in {explorer_path}; refusing to continue.")

          explorer_updated, explorer_reasoning_replacements = re.subn(
              r'(?m)^model_reasoning_effort\s*=\s*".*"$',
              'model_reasoning_effort = "xhigh"',
              explorer_updated,
          )
          if explorer_reasoning_replacements == 0:
              raise SystemExit(f"Expected model_reasoning_effort target not found in {explorer_path}; refusing to continue.")

          # Optional forward-compat for potential future naming.
          explorer_updated, explorer_thinking_replacements = re.subn(
              r'(?m)^model_thinking_effort\s*=\s*".*"$',
              'model_thinking_effort = "xhigh"',
              explorer_updated,
          )
          explorer_updated, explorer_thinking_replacements_alt = re.subn(
              r'(?m)^thinking_effort\s*=\s*".*"$',
              'thinking_effort = "xhigh"',
              explorer_updated,
          )

          if explorer_updated != explorer_text:
              explorer_path.write_text(explorer_updated)
          print(
              f"Patched {explorer_path} "
              f"(model: {explorer_model_replacements}, reasoning_effort: {explorer_reasoning_replacements}, "
              f"thinking_effort: {explorer_thinking_replacements + explorer_thinking_replacements_alt})"
          )

          config_path = Path(os.environ["CONFIG_FILE_PATH"])
          config_text = config_path.read_text()
          config_updated = config_text.replace(
              "DEFAULT_AGENT_MAX_THREADS: Option<usize> = Some(6);",
              "DEFAULT_AGENT_MAX_THREADS: Option<usize> = Some(12);",
          )
          if config_updated == config_text:
              raise SystemExit(f"Expected patch targets not found in {config_path}; refusing to continue.")
          config_path.write_text(config_updated)
          print(f"Patched {config_path}")
          PY

      - name: Cache cargo build
        if: steps.existing.outputs.exists == 'false'
        uses: actions/cache@v5
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            ~/.cargo/bin
            ~/.rustup
            codex-src/codex-rs/target
          key: ${{ runner.os }}-cargo-${{ env.BUILD_TARGET }}-${{ hashFiles('codex-src/codex-rs/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ env.BUILD_TARGET }}-

      - name: Install Rust toolchain
        if: steps.existing.outputs.exists == 'false'
        run: |
          set -euo pipefail
          if ! command -v rustup >/dev/null 2>&1; then
            curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --profile minimal
          fi
          echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"

      - name: Build codex CLI
        if: steps.existing.outputs.exists == 'false'
        working-directory: codex-src/codex-rs
        run: |
          set -euo pipefail
          source "$HOME/.cargo/env"
          rustup target add "$BUILD_TARGET"
          cargo build --release --bin codex --target "$BUILD_TARGET"

      - name: Package artifact
        if: steps.existing.outputs.exists == 'false'
        run: |
          set -euo pipefail
          bin_path="codex-src/codex-rs/target/${BUILD_TARGET}/release/codex"
          if [ ! -f "$bin_path" ]; then
            echo "codex binary not found at $bin_path" >&2
            exit 1
          fi
          mkdir -p dist
          artifact_name="codex-${BUILD_TARGET}"
          cp "$bin_path" "dist/${artifact_name}"
          tarball="codex-${{ steps.upstream.outputs.tag }}-${BUILD_TARGET}.tar.gz"
          tar -czf "dist/${tarball}" -C dist "${artifact_name}"
          (cd dist && sha256sum "${tarball}" > "${tarball}.sha256")

      - name: Create GitHub release
        if: steps.existing.outputs.exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          release_tag="${{ steps.existing.outputs.release_tag }}"
          prerelease_flag=""
          if [ "${{ steps.upstream.outputs.prerelease }}" = "true" ]; then
            prerelease_flag="--prerelease"
          fi
          cat > release-notes.txt <<EOF
          Built from \`${UPSTREAM_REPO}\` tag \`${{ steps.upstream.outputs.tag }}\`.
          Applied model + effort patch (model -> gpt-5.3-codex, thinking_effort/reasoning_effort -> xhigh where available).
          Raised default sub-agent thread limit (\`agents.max_threads\`) from 6 to 12.
          Upstream prerelease: \`${{ steps.upstream.outputs.prerelease }}\`.
          Artifact target: \`${BUILD_TARGET}\`.
          EOF
          gh release create "$release_tag" dist/*.tar.gz dist/*.sha256 \
            --title "Codex ${{ steps.upstream.outputs.tag }} (patched)" \
            --notes-file release-notes.txt \
            ${prerelease_flag} \
            --target "${GITHUB_SHA}"
